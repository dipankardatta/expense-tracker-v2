<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link rel="stylesheet" href="../styles/expense.css">
</head>

<body>
    <div id="container">
        <form id="expense-form">
            <div class="form-group">
                <label for="expense-name">Expense Name:</label>
                <input type="text" id="expense-name" required>
            </div>
            <div class="form-group">
                <label for="expense-amount">Amount:</label>
                <input type="number" id="expense-amount" required>
            </div>
            <button type="submit">Add</button>
        </form>

        <div id="premiummsg"></div>
        <button id="rzp-btn1"> !! BUY PREMIUM !!</button>

        <div id="message"></div>
        <div id="leaderboard"></div>

        <h3>Expense List</h3>
        <ul id="expenses-list"></ul>

        <div>Total Expense: Rs<span id="total-expense">0.00</span></div>
        <button onclick="download()" id="downloadexpense">Download File</button>
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const form = document.getElementById('expense-form');
        const inputName = document.getElementById('expense-name');
        const inputAmount = document.getElementById('expense-amount');
        const expensesList = document.getElementById('expenses-list');
        const totalExpense = document.getElementById('total-expense');
        const API_URL = 'http://localhost:3000/users/expenses';
        const token = localStorage.getItem('token')
        const rzpbtn = document.getElementById("rzp-btn1")

        window.addEventListener('DOMContentLoaded', function (event) {
            const decodetoken = parseJwt(token)
            const ispremiumuser = decodetoken.ispremiumuser
            console.log(ispremiumuser)
            if (ispremiumuser) {
                showPremiumuserMessage()
                showLeaderboard()
                download()
            }
        })


        // Add a new expense to the database and update the total
        async function addExpense(name, amount) {
            try {
                console.log('Adding expense:', name, amount);
                const response = await axios.post(API_URL, { name, amount }, { headers: { 'Authorization': token } });
                console.log(response)
                // updateTotal();
                renderExpenses();
            } catch (error) {
                console.error(error);
            }
        }

        // Remove an expense from the database and update the total
        async function removeExpense(id) {
            try {
                const response = await axios.delete(`${API_URL}/${id}`, { headers: { 'Authorization': token } });
                console.log(response)
                // updateTotal();
                renderExpenses();
            } catch (error) {
                console.error(error);
            }
        }

        // Update the total value of all expenses
        // async function updateTotal() {
        //     try {
        //         const response = await axios.get(API_URL, { headers: { 'Authorization': token } });
        //         const total = response.data.expense.reduce((acc, cur) => acc + cur.amount, 0);
        //         totalExpense.textContent = total.toFixed(2);
        //     } catch (error) {
        //         console.error(error);
        //     }
        // }

        // function to show message
        function showPremiumuserMessage() {
            rzpbtn.style.visibility = 'hidden'
            document.getElementById('premiummsg').innerHTML = "HEY WELCOME TO THE PREMIUM FAMILY"
        }

        // decoding jwt code without using library
        function parseJwt(token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        }

        // handling razorpay button

        rzpbtn.onclick = async function (e) {
            const response = await axios.get('http://localhost:3000/purchase/premiummembership', { headers: { 'Authorization': token } });
            console.log(response.data.key_id);

            var options = {
                "key": response.data.key_id,
                "order_id": response.data.order.id,
                'handler': async function (response) {
                    const updateResponse = await axios.post('http://localhost:3000/purchase/updatestatus', {
                        order_id: options.order_id,
                        payment_id: response.razorpay_payment_id
                    }, { headers: { 'Authorization': token } });

                    alert('You are a premium user now');
                    rzpbtn.style.visibility = 'hidden'
                    localStorage.setItem('token', updateResponse.data.token)
                    console.log(updateResponse.data.token)
                    showPremiumuserMessage()
                    showLeaderboard()
                    download()
                    // document.getElementById('premiummsg').innerHTML = "HEY WELCOME TO THE PREMIUM FAMILY"

                },
            };

            const rzpl = new Razorpay(options);
            rzpl.open();
            e.preventDefault();

            rzpl.on('payment.failed', function (response) {
                console.log(response);
                alert('Something went wrong');
            });
        };



        // Render the list of expenses from the database to the page
        // ...

        // Render the list of expenses from the database to the page
        function renderExpenses() {
            axios
                .get(API_URL, { headers: { 'Authorization': token } })
                .then(response => {
                    expensesList.innerHTML = '';
                    let total = 0; // Initialize total expense
                    response.data.expense.forEach(expense => {
                        const li = document.createElement('li');
                        li.innerHTML = `${expense.name}: Rs ${expense.amount.toFixed(2)} <button class="delete" data-id="${expense.id}">X</button>`;
                        expensesList.appendChild(li);
                        total += expense.amount; // Accumulate expense amount
                    });
                    totalExpense.textContent = total.toFixed(2); // Display total expense
                })
                .catch(error => {
                    console.error(error);
                });
        }

        // ...


        // Handle form submit event
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const name = inputName.value;
            const amount = parseFloat(inputAmount.value);
            await addExpense(name, amount);
            inputName.value = '';
            inputAmount.value = '';
        });

        // Handle delete button click event
        expensesList.addEventListener('click', async e => {
            if (e.target.matches('button.delete')) {
                const id = e.target.dataset.id;
                await removeExpense(id);
            }
        });

        function showLeaderboard() {
            const inputElement = document.createElement('input')
            inputElement.type = 'button'
            inputElement.value = 'Show Leaderboard'
            inputElement.onclick = async () => {
                const userLeaderBoardArray = await axios.get('http://localhost:3000/premium/showleaderboard', { headers: { 'Authorization': token } })
                console.log(userLeaderBoardArray)

                var leaderboardElem = document.getElementById('leaderboard')
                leaderboardElem.innerHTML += '<h1> Leader Board</h1>'
                userLeaderBoardArray.data.forEach((userDetails) => {
                    leaderboardElem.innerHTML += `<li> Name - ${userDetails.name} Total Expenses ${userDetails.totalExpenses}</li>`
                })
            }
            document.getElementById('message').appendChild(inputElement)
        }
        function download() {
            axios.get('http://localhost:3000/users/expenses/download', { headers: { "Authorization": token } })
                .then((response) => {
                    if (response.status === 201) {
                        //the bcakend is essentially sending a download link
                        //  which if we open in browser, the file would download
                        var a = document.createElement("a");
                        a.href = response.data.fileURL;
                        a.download = 'myexpense.csv';
                        a.click();
                    } else {
                        throw new Error(response.data.message)
                    }

                })
                .catch((err) => {
                    console.log(err)
                });
        }

        // Render the initial list of expenses and total
        renderExpenses();
        // updateTotal();
    </script>
</body>

</html>